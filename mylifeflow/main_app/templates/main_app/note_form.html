{% extends 'base.html' %} {% load static %} 
{% load widget_tweaks %}
{% block content %}
<!-- Include Material Icons -->
<link
  href="https://fonts.googleapis.com/icon?family=Material+Icons"
  rel="stylesheet"
/>

<body
  class="bg-gradient-to-b from-[#bbe4ff] to-[#87cefd] font-sans text-[#091638] m-0 p-0"
>
  <div class="bg-white rounded-2xl p-8 max-w-xl w-11/12 mx-auto mt-8 shadow-lg">
    {% if object %}
    <h1 class="text-[#091638] mb-6 text-3xl text-center font-semibold">
      Edit <span class="text-teal-400">{{ object.title }}</span>
    </h1>
    {% else %}
    <h1 class="text-[#091638] mb-6 text-3xl text-center font-semibold">
      Add Note
    </h1>
    {% endif %}

    <form
      method="POST"
      enctype="multipart/form-data"
      id="noteForm"
      class="space-y-6"
    >
      {% csrf_token %}

      <div class="flex flex-col w-full">
        <label
          for="{{ form.title.id_for_label }}"
          class="flex items-center gap-2 text-[#091638] font-medium mb-2 text-base"
        >
          <i class="material-icons text-lg">edit_note</i> {{ form.title.label }}
        </label>
        {{ form.title|add_class:"border border-[#28304a] rounded-md p-3
        text-[#28304a] focus:outline-none focus:border-blue-600" }}
      </div>

      <div class="flex flex-col w-full">
        <label
          for="{{ form.text.id_for_label }}"
          class="flex items-center gap-2 text-[#091638] font-medium mb-2 text-base"
        >
          <i class="material-icons text-lg">description</i> {{ form.text.label
          }}
        </label>
        {{ form.text|add_class:"border border-[#28304a] rounded-md p-3
        text-[#28304a] focus:outline-none focus:border-blue-600 resize-none
        h-32" }}
      </div>

      <div class="flex flex-col w-full">
        <label
          for="{{ form.image.id_for_label }}"
          class="flex items-center gap-2 text-[#091638] font-medium mb-2 text-base"
        >
          <i class="material-icons text-lg">image</i> {{ form.image.label }}
        </label>
        {{ form.image|add_class:"border border-[#28304a] rounded-md p-3
        text-[#28304a] focus:outline-none focus:border-blue-600" }}
      </div>

      {% if form.created_at %}
      <div class="flex flex-col w-full">
        <label
          for="{{ form.created_at.id_for_label }}"
          class="flex items-center gap-2 text-[#091638] font-medium mb-2 text-base"
        >
          <i class="material-icons text-lg">calendar_today</i> {{
          form.created_at.label }}
        </label>
        {{ form.created_at|add_class:"border border-[#28304a] rounded-md p-3
        text-[#28304a] focus:outline-none focus:border-blue-600" }}
      </div>
      {% endif %}

      <div class="flex justify-center gap-4 mt-4">
        <button
          type="button"
          onclick="startRecognition()"
          class="inline-flex items-center gap-1 border border-blue-600 text-blue-600 bg-white rounded-md px-4 py-2 text-sm hover:bg-blue-50"
        >
          <i class="material-icons">mic</i> Speak
        </button>
        <button
          type="button"
          onclick="stopRecognition()"
          class="inline-flex items-center gap-1 border border-red-600 text-red-600 bg-white rounded-md px-4 py-2 text-sm hover:bg-red-50"
        >
          <i class="material-icons">stop</i> Stop
        </button>
      </div>

      <button
        type="submit"
        class="w-full mt-6 bg-blue-700 hover:bg-blue-800 text-white rounded-md py-3 text-lg flex items-center justify-center gap-2 transition"
      >
        <i class="material-icons">save</i> Save Note
      </button>
    </form>
  </div>

  <script>
    window.SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition
    const recognition = new SpeechRecognition()
    recognition.interimResults = true

    let finalTranscript = ''
    let lastFinalTranscript = ''

    recognition.addEventListener('result', (e) => {
      const transcript = Array.from(e.results)
        .map((result) => result[0])
        .map((result) => result.transcript)
        .join('')

      if (e.results[0].isFinal) {
        if (transcript !== lastFinalTranscript) {
          finalTranscript += transcript + ' '
          const textField = document.getElementById('text')
          if (textField) {
            textField.value = finalTranscript
          }
          lastFinalTranscript = transcript
        }
      }
    })

    recognition.addEventListener('end', () => {
      if (!recognition.stoppedManually) {
        recognition.start()
      }
    })

    const startRecognition = () => {
      const textField = document.getElementById('text')
      if (textField) {
        finalTranscript = textField.value || ''
      }
      lastFinalTranscript = ''
      recognition.stoppedManually = false
      recognition.start()
    }

    const stopRecognition = () => {
      recognition.stoppedManually = true
      recognition.stop()
    }
  </script>
</body>
{% endblock %}
